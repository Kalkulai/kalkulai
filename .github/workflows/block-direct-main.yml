name: Guard Main Branch

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  issues: write

jobs:
  revert-direct-push:
    if: >
      github.event.head_commit != null
      && github.event.pusher.name != 'GitHub'
      && github.actor != 'dependabot[bot]'
      && github.actor != 'github-actions[bot]'
      && !contains(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest
    steps:
      - name: Check previous commit
        env:
          PREV_SHA: ${{ github.event.before }}
        run: |
          if [[ "$PREV_SHA" == "" || "$PREV_SHA" == "0000000000000000000000000000000000000000" ]]; then
            echo "::error ::Cannot determine previous commit to restore. Please revert manually."
            exit 1
          fi

      - name: Restore main to previous commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Force reset remote main
        env:
          PREV_SHA: ${{ github.event.before }}
        run: |
          git fetch origin main --depth=1
          git push origin "$PREV_SHA:refs/heads/main" --force

      - name: Create warning issue
        uses: actions/github-script@v7
        with:
          script: |
            const head = context.payload.head_commit || {};
            const title = `Direkter Push von ${context.actor} wurde zurückgesetzt`;
            const issueBody = [
              `**Commit:** ${head.id || 'unbekannt'}`,
              `**Autor:** ${head.author?.name || context.actor}`,
              `**Commit Message:** ${head.message || '—'}`,
              '',
              'Der Guard-Workflow hat den Push auf `main` automatisch rückgängig gemacht.',
              'Bitte arbeite künftig über Pull Requests.'
            ].join('\n');
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: issueBody,
                labels: ['direct-push-blocked']
              });
            } catch (error) {
              core.warning(`Konnte Issue nicht erstellen: ${error.message}`);
            }

      - name: Fail workflow (direct push blocked)
        run: |
          echo "::error ::Direct pushes to main are reverted automatically. Bitte arbeite über Pull Requests."
          exit 1
